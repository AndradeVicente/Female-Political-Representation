---
title: "Análise PEE - Impacto da eleição de um prefeito negro no índice de homicídios"
author: "Maria Eduarda"
date: "2024-10-23"
output: html_document
---


# Bibliotecas

```{r}
library(tidyverse)
library(rdrobust)
library(readxl)
```


# Dados TSE

```{r}

candidatos <- readRDS("candidates-att.rds")

prefeitos <- candidatos %>% 
  filter(ano %in% c(2016, 2020)) %>% 
  mutate(x_cor_raca = case_when(cor_raca == "PRETA" ~ "preta",
                   cor_raca == "PARDA" ~ "preta",
                   cor_raca == "BRANCA" ~ "branca",
                   .default = NA)) %>% 
  group_by(ano, estado, cd_municipio_tse) |> 
  arrange(desc(total_votos)) |> 
  slice_head(n = 2) %>%
  group_by(ano, estado, cd_municipio_tse) |>
  filter(!is.na(x_cor_raca)) |>
  filter(n_distinct(x_cor_raca) == 2) %>% 
  mutate(preto_eleito = ifelse(x_cor_raca == "preta" & resultado == "Eleito", 1, 0),
         mg_preto = (total_votos[x_cor_raca == 'preta'] - total_votos[x_cor_raca == 'branca'])/sum(total_votos),
         pop_total = pop_mas + pop_fem,
         educacao_agr = case_when(educacao %in% c('1º GRAU COMPLETO', '1º GRAU INCOMPLETO', 'ENSINO FUNDAMENTAL COMPLETO', 'ENSINO FUNDAMENTAL INCOMPLETO', 'FUNDAMENTAL COMPLETO', 'FUNDAMENTAL INCOMPLETO', 'ANALFABETO', 'LÊ E ESCREVE') ~ 'fundamental',
           educacao %in% c('2º GRAU COMPLETO', '2º GRAU INCOMPLETO', 'ENSINO MÉDIO COMPLETO', 'ENSINO MÉDIO INCOMPLETO', 'MÉDIO COMPLETO', 'MÉDIO INCOMPLETO') ~ 'medio',
           educacao %in% c('SUPERIOR COMPLETO', 'SUPERIOR INCOMPLETO') ~ 'superior',
           TRUE ~ NA_character_),
         codigo_ibge_sus = as.character(codigo_ibge_sus)) |>
  filter(resultado == 'Eleito', pop_votante <= 200000) |> 
  ungroup()

```

## Histograma
```{r}

prefeitos %>% 
  ggplot(aes(x = mg_preto, fill = factor(preto_eleito))) + 
  geom_histogram(boundary = 0, binwidth = 0.05, color = 'white') + 
  geom_vline(xintercept = 0) +
  scale_fill_manual(values = c("#e9d8a6", "#ae2012"),
                    labels = c("Branco Eleito", "Preto Eleito")) +
  labs(title = "Distribuição de Margens de Vitória em Municípios Brasileiros",
       subtitle = "Eleições entre Pretos e Brancos (2016)",
       x = "Margem de Vitória de Negros",
       y = NULL,
       fill = NULL) + 
  theme_minimal() + 
  theme(legend.position = "top",
        plot.caption = element_text(color = "#3494ba", size = 11),
        plot.title = element_text(size = 14),
        plot.subtitle = element_text(size = 11, color = 'black'),
        axis.title.y = element_text(margin = margin(r = 10, unit = "pt"), size = 11), 
        axis.title.x = element_text(margin = margin(t = 10, unit = "pt"), size = 11)) +
  scale_x_continuous(labels = scales::percent)
```


# DATASUS

```{r}

df_homicides <- readRDS("simsus-homicidio.rds") 

simsus_homicidio <- df_homicides |> 
  filter(mandato >= 2004,
         idade_15_29 == TRUE) |> 
  group_by(mandato, cd_muni_ibge) |> 
  summarise(y_homicide = sum(y_homicide == TRUE)) |> 
  ungroup() |> 
  arrange(cd_muni_ibge, mandato) |> 
  group_by(cd_muni_ibge) |> 
  mutate(y_homicide_previous = lag(y_homicide))
  



```

# Controles

```{r}

df_pop_preta <- read_xlsx("Dados/pop.xlsx")

df_demo_c <- df_pop_preta |> 
  select(cd_muni_ibge = Cód.,
         Total,
         Preta,
         Parda,
         pib_pc = `PIB per Capita`) |> 
  mutate(pop_preta = Preta + Parda,
         prop_preta = pop_preta/Total,
         cd_muni_ibge = as.numeric(cd_muni_ibge)) |> 
  select(cd_muni_ibge, pib_pc, prop_preta)
  

```


# Base RDD
```{r}

base_rdd <- prefeitos |> 
  left_join(simsus_homicidio, by = c('ano' = 'mandato', 'codigo_ibge_sus' = 'cd_muni_ibge')) |>
  left_join(df_demo_c, by = c('codigo_ibge'='cd_muni_ibge')) |> 
  filter(ano %in% c(2016, 2020)) |> 
  mutate(codigo_ibge = as.factor(codigo_ibge),
         across(starts_with('y_'), ~ (./pop_total)*100000),
         across(starts_with('y_'), ~ replace_na(., 0)),
         y_homicide_year = case_when(ano == 2020 ~ y_homicide/2,
                                     .default = y_homicide/4), 
         ano = as.factor(ano),
         educacao_agr = as.factor(educacao_agr),
         partido = as.factor(partido),
         preto_eleito = as.factor(preto_eleito),
         genero = as.factor(genero)) |> 
  filter(codigo_ibge != 1504752)

```

# Descritiva


```{r}
# dados numericos
base_rdd |> 
  group_by(preto_eleito) |> 
  summarize(
    idade = mean(idade),
    idade_sd = sd(idade),
    pop = mean(pop_total),
    pop_sd = sd(pop_total),
    pib = mean(pib_pc),
    pib_sd = sd(pib_pc),
    prop_preta = mean(prop_preta),
    prop_preta_sd = sd(prop_preta))

```


```{r}

base_rdd |> 
  ggplot(aes(x = pib_pc, fill = preto_eleito)) + 
  geom_density(alpha = .75) + 
  xlim(0,100000)


```


```{r}
# partido
base_rdd |> 
  count(partido, preto_eleito, sort = TRUE) |> 
  group_by(partido) |> 
  mutate(total = sum(n)) |>
  ungroup() |> 
  group_by(preto_eleito) |> 
  mutate(total_etnico = sum(n),
         prop_total = n/total_etnico) |> 
  ungroup() |> 
  arrange(desc(total))


```

```{r}

# partido
base_rdd |> 
  count(genero, preto_eleito, sort = TRUE) |> 
  group_by(genero) |> 
  mutate(prop_genero_eleito = n / sum(n))

```

```{r}

# partido
base_rdd |> 
  count(educacao_agr, preto_eleito, sort = TRUE) |> 
  group_by(educacao_agr) |> 
  mutate(prop_educ = n/sum(n))
  

```


# RDD 
## tx homicido mandato

```{r}

controls <- model.matrix(~ idade + partido + pop_total + educacao_agr + pib_pc + prop_preta + genero, data = base_rdd)


rdplot(base_rdd$y_homicide, base_rdd$mg_preto, c = 0, nbins = c(100, 100), kernel = 'triangular', x.lim = c(-0.165,0.165), y.lim = c(20,75), p = TRUE)


rdrobust(base_rdd$y_homicide, base_rdd$mg_preto,
         c = 0,
         kernel = 'triangular',
         cluster = base_rdd$codigo_ibge,
         covs = controls,
         all = TRUE) |> 
  summary()


base_cct <- base_rdd |>
  filter(abs(mg_preto) <= 0.155)

rdplot(base_cct$y_homicide, base_cct$mg_preto, c = 0, nbins = c(10, 10), kernel = 'triangular', x.lim = c(-0.155,0.155), y.lim = c(20,75), p = TRUE)


```
## tx homicido ano

```{r}

controls <- model.matrix(~ idade + partido + pop_total + educacao_agr + pib_pc + prop_preta + genero, data = base_rdd)


rdplot(base_rdd$y_homicide_year, base_rdd$mg_preto, c = 0, nbins = c(100, 100), kernel = 'triangular', y.lim = c(5,20), p = TRUE, x.lim = c(-.164,.164))


rdrobust(base_rdd$y_homicide_year, base_rdd$mg_preto,
         c = 0,
         kernel = 'triangular',
         cluster = base_rdd$codigo_ibge,
         covs = controls,
         all = TRUE) |> 
  summary()


base_cct <- base_rdd |>
  filter(abs(mg_preto) <= 0.164)

rdplot(base_cct$y_homicide_year, base_cct$mg_preto, c = 0, nbins = c(10, 10), kernel = 'triangular', x.lim = c(-0.155,0.155), y.lim = c(0,25), p = TRUE)


```


```{r}

base_cct <- base_rdd |>
  filter(abs(mg_preto) <= 0.165)

rdplot(base_cct$y_homicide, base_cct$mg_preto, c = 0, nbins = c(10, 10), kernel = 'triangular', x.lim = c(-0.153,0.153), y.lim = c(50,125), p=TRUE)

rdplot(base_rdd$y_homicide, base_rdd$mg_preto, c = 0, nbins = c(100, 100), kernel = 'triangular', x.lim = c(-0.153,0.153), y.lim = c(50,125), p=TRUE)

rdplot(base_rdd$y_homicide, base_rdd$mg_preto, c = 0, nbins = c(100, 100), kernel = 'triangular', x.lim = c(-.5,.5), y.lim = c(50,125), p = TRUE)

```




# robustez

```{r, warning=FALSE}

bandwidths <- seq(.05, 1, by = .1)

df_sensibilidade_bw <- data.frame(bandwidth = numeric(), p_value = numeric(), beta = numeric())

for (bw in bandwidths) {
  rd_robust_result <- rdrobust(base_rdd$y_homicide_year, base_rdd$mg_preto,
                               h = bw,
                               c = 0,
                               kernel = 'triangular',
                               cluster = base_rdd$codigo_ibge,
                               covs = controls,
                               all = TRUE)


  pv <- rd_robust_result$pv[3]
  beta <- rd_robust_result$coef[3]
  
  df_sensibilidade_bw <- rbind(df_sensibilidade_bw, data.frame(bandwidth = bw, p_value = pv, beta = beta))}

df_sensibilidade_bw |> 
  ggplot(aes(y = p_value, x = bandwidth)) + 
  geom_line() + 
  labs(title = "Sensibilidade do P-Valor a Margem",
       x = "Largura de Banda",
       y = "P-valor") + 
  ylim(0,1)

df_sensibilidade_bw |> 
  ggplot(aes(y = beta, x = bandwidth)) + 
  geom_line() + 
  labs(title = "Sensibilidade do Coeficiente a Margem",
       x = "Largura de Banda",
       y = "beta") 


```

```{r}


rdplot(base_rdd$y_homicide_previous, base_rdd$mg_preto, c = 0, nbins = c(100, 100), kernel = 'triangular', x.lim = c(-0.169,0.169), y.lim = c(50,125), p = TRUE)


rdrobust(base_rdd$y_homicide_previous, base_rdd$mg_preto,
         c = 0,
         kernel = 'triangular',
         cluster = base_rdd$codigo_ibge,
         covs = controls,
         all = TRUE,
         p = TRUE) |> 
  summary()

```












